{
    "componentChunkName": "component---src-pages-blog-mdx-slug-js",
    "path": "/blog/22-01-nut-server/",
    "result": {"data":{"mdx":{"body":"var _excluded = [\"components\"];\n\nfunction _extends() { _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; }; return _extends.apply(this, arguments); }\n\nfunction _objectWithoutProperties(source, excluded) { if (source == null) return {}; var target = _objectWithoutPropertiesLoose(source, excluded); var key, i; if (Object.getOwnPropertySymbols) { var sourceSymbolKeys = Object.getOwnPropertySymbols(source); for (i = 0; i < sourceSymbolKeys.length; i++) { key = sourceSymbolKeys[i]; if (excluded.indexOf(key) >= 0) continue; if (!Object.prototype.propertyIsEnumerable.call(source, key)) continue; target[key] = source[key]; } } return target; }\n\nfunction _objectWithoutPropertiesLoose(source, excluded) { if (source == null) return {}; var target = {}; var sourceKeys = Object.keys(source); var key, i; for (i = 0; i < sourceKeys.length; i++) { key = sourceKeys[i]; if (excluded.indexOf(key) >= 0) continue; target[key] = source[key]; } return target; }\n\n/* @jsxRuntime classic */\n\n/* @jsx mdx */\nvar _frontmatter = {\n  \"title\": \"QNAP as a NUT server with clients\",\n  \"date\": \"2022-01-15\",\n  \"hero_image\": \"./powerlines.jpg\",\n  \"hero_image_alt\": \"hero\",\n  \"hero_image_credit_text\": \"Jan Huber\",\n  \"hero_image_credit_link\": \"https://unsplash.com/photos/ZWH6Wm4rUw4\",\n  \"embeddedImagesLocal\": [\"ups-nut-setup.jpg\", \"nut-server.jpg\"]\n};\nvar layoutProps = {\n  _frontmatter: _frontmatter\n};\nvar MDXLayout = \"wrapper\";\nreturn function MDXContent(_ref) {\n  var components = _ref.components,\n      props = _objectWithoutProperties(_ref, _excluded);\n\n  return mdx(MDXLayout, _extends({}, layoutProps, props, {\n    components: components,\n    mdxType: \"MDXLayout\"\n  }), mdx(\"p\", null, \"Nice thing about UPS devices is that they can be connected to a computer via USB cable and in case of power outage, UPS can signal that machine to shut itself down after certain perod of time, if the power grid does not recover. Moreover there is a tool called NUT (\", mdx(\"a\", {\n    parentName: \"p\",\n    \"href\": \"https://networkupstools.org/documentation.html\"\n  }, \"Network UPS Tools\"), \") which can play the server/client role, so that the server propagates this information to other devices powered by the same UPS, to shut themselves down as well. This is what this post is about.\"), mdx(\"p\", null, \"There are few minor specifics to running QNAP as a NUT server, compared to the usual way of installing it on a server, so I will outline those details here and hopefully save someone or my future self a bit of troubleshooting time.\"), mdx(\"h3\", {\n    \"id\": \"high-level-overview\"\n  }, \"High Level Overview\"), mdx(\"p\", null, \"At the moment I am running couple of services inside my QNAP NAS server at home. Some of them being Home Assistant VM, natively installed QNAP apps such as Plex, qBittorent, Radarr, Sonarr etc. Also there are few docker containers running. I realized that in case of power loss, I might not only loose the data, but I might as well have to go again thorugh the trouble of setting up those services. This is something I would rather avoid doing, if possible.\"), mdx(\"p\", null, \"This diagram depicts the setup and below is an explaination:\"), mdx(GatsbyImage, {\n    alt: \"architecture\",\n    image: getImage(props.localImages[0]),\n    mdxType: \"GatsbyImage\"\n  }), mdx(\"p\", null, \"My QNAP NAS is connected with the UPS via a USB cable, and plays the role of a NUT server. When the power goes down UPS falls back to using battery. If the power does not come back after x minutes NAS will shut itself down gracefully bringing with it all the apps, VMs, and docker containers as well. \"), mdx(\"p\", null, \"On top of that, it will signal to other devices on my network (NUT clients) that are also being powered by this same UPS and tell them they are now running on battery and they should turn off. One thing to keep in mind is this requires network connectivity between NUT server and it\\u2019s clients, even after the grid went down. For this reason, I am making sure this is the case by powering my switch via UPS as well.\"), mdx(\"p\", null, \"Hardware should not make much of a difference, except the fact that QNAP is providing the server software adaptation with some specifics related to it. I will explain this below. To be transparent about the hardware I am using, here are some of the details. My NAS server is a QNAP 253Be with two 10TB Seagate IronWolf disks running in RAID 1 mode. My UPS is an APC Smart-UPS 750VA LCD 230V. NAS model should not matter too much, as long as it is running similar version of QTS which is QNAP\\u2019s own linux distribution. Version I am running is 4.5.4.\"), mdx(\"p\", null, \"With that out of the way, we move on to practical things.\"), mdx(\"h3\", {\n    \"id\": \"setting-up-nut-server-on-qnap\"\n  }, \"Setting up NUT server on QNAP\"), mdx(\"p\", null, \"Once the USB cable is connected beetwen the UPS and NAS it should show up as an external device. Navigate to the Control Panel and then the External Device and you should see your UPS USB connection settings.\"), mdx(GatsbyImage, {\n    alt: \"ups-power-lines\",\n    image: getImage(props.localImages[1]),\n    mdxType: \"GatsbyImage\"\n  }), mdx(\"p\", null, \"Here you will want to check the \\u201CEnable network UPS master\\u201D checkbox and enter IP addresses of the machines you are also powering with this same UPS and you want to shutdown.\"), mdx(\"p\", null, \"Now here comes the important part. Pay attention to the next couple of paragraphs. \"), mdx(\"p\", null, \"First of all QTS (QNAP operating system) stores NUT configuration files, unlike debian based systems, in the following location:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"/etc/config/ups\\n\")), mdx(\"p\", null, \"What you would normally do on NUT server, is edit \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"upsd.conf\"), \" and add your client machines to the ACL. Don\\u2019t do that!\\nWhen you tick the \\u201CEnable network UPS master\\u201D checkbox in the Control Panel screen, adding an IP address to this table actually adds that IP address automaticaly to the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"upsd.conf\"), \" giving it a generic name like \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_1\"), \". \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"client_2\"), \" etc. for each IP address in this table. If by some chance you edit this file manually, be aware that your changes will be lost after system reboot. So, add your clients\\u2019 IP addresses through Control Panel UI.\"), mdx(\"p\", null, \"What you actually want to do is add accounts for NUT clients to connect to this server. In case you don\\u2019t care a lot you can use one account for all your nut clients to authenticate to your server. Defining such account in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"upsd.users\"), \" can be as simple as this:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"[nutclient]\\n        password = my_ups_password\\n        allowfrom = client_1 client_2\\n        upsmon slave\\n\")), mdx(\"p\", null, \"As you can see clients 1 and 2 can both use this account to authenticate to the server. After that is done, no further action is required on the server side.\"), mdx(\"h3\", {\n    \"id\": \"setting-up-nut-clients\"\n  }, \"Setting up NUT clients\"), mdx(\"p\", null, \"We will now setup other computers powered by the same UPS. This is a fairly simple thing to do. NUT client can be installed pretty much everhywhere, be it one of many supported Linux or BSD distributions, MacOS or even Windows. For everyone of those there is a corresponding binary package which you install and configure to connect to your QNAP Nut server.\"), mdx(\"p\", null, \"For example let\\u2019s say you are using Ubuntu, then you would install the client by running:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\",\n    \"className\": \"language-bash\"\n  }, \"sudo apt install nut-client\\n\")), mdx(\"p\", null, \"This will probably create two files in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"/etc/nut\"), \" folder. Make sure \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"nut.conf\"), \" has the following content:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"MODE=netclient\\n\")), mdx(\"p\", null, \"Finally in the same location in \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"upsmon.conf\"), \" add the following line:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"MONITOR qnapups@<your_qnap_nut_server_ip> 1 nutclient my_ups_password slave\\n\")), mdx(\"p\", null, \"Word of warning here, make sure you enter the correct IP address of your NUT server here, and make sure that the username and password match what you entered in the \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"upsd.users\"), \" on the server. Don\\u2019t change \", mdx(\"inlineCode\", {\n    parentName: \"p\"\n  }, \"qnapups\"), \" string! This will always be the same.\\nYou can check if the client/server connection works by running this command on the client:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"upsc qnapups@<your_qnap_nut_server_ip> ups.status\\n\")), mdx(\"p\", null, \"If everything went well, it should show output similar to this\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"\\u279C  ~ upsc qnapups@<your_qnap_nut_server_ip> ups.status\\nOL\\n\")), mdx(\"p\", null, \"Monitor entries are written to syslog, so you can tail for those with:\"), mdx(\"pre\", null, mdx(\"code\", {\n    parentName: \"pre\"\n  }, \"tail -n 2000 -f /var/log/syslog | grep --line-buffered upsmon\\n\")), mdx(\"h3\", {\n    \"id\": \"conclusion\"\n  }, \"Conclusion\"), mdx(\"p\", null, \"As you an see this is a pretty simple, yet powerful setup. It alows you to power as many device as your UPS can handle and shut them all down, in an automated maner in case of power grid outage, hopefully withouth any damage to your systems.\"), mdx(\"p\", null, \" I hope you found this text useful.\"));\n}\n;\nMDXContent.isMDXComponent = true;","frontmatter":{"title":"QNAP as a NUT server with clients","date":"January 15, 2022","hero_image_alt":"hero","hero_image_credit_link":"https://unsplash.com/photos/ZWH6Wm4rUw4","hero_image_credit_text":"Jan Huber","hero_image":{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#080808","images":{"fallback":{"src":"/static/8a78de58f20078627ebc1f8a1f9d5def/c6f35/powerlines.jpg","srcSet":"/static/8a78de58f20078627ebc1f8a1f9d5def/a659f/powerlines.jpg 590w,\n/static/8a78de58f20078627ebc1f8a1f9d5def/1c96e/powerlines.jpg 1179w,\n/static/8a78de58f20078627ebc1f8a1f9d5def/c6f35/powerlines.jpg 2358w","sizes":"(min-width: 2358px) 2358px, 100vw"},"sources":[{"srcSet":"/static/8a78de58f20078627ebc1f8a1f9d5def/04ef5/powerlines.webp 590w,\n/static/8a78de58f20078627ebc1f8a1f9d5def/38d83/powerlines.webp 1179w,\n/static/8a78de58f20078627ebc1f8a1f9d5def/5040a/powerlines.webp 2358w","type":"image/webp","sizes":"(min-width: 2358px) 2358px, 100vw"}]},"width":2358,"height":1556}}},"embeddedImagesLocal":[{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/d99b0737a2868a414fc5fb40955bf63d/0eecd/ups-nut-setup.jpg","srcSet":"/static/d99b0737a2868a414fc5fb40955bf63d/179ea/ups-nut-setup.jpg 156w,\n/static/d99b0737a2868a414fc5fb40955bf63d/6513f/ups-nut-setup.jpg 311w,\n/static/d99b0737a2868a414fc5fb40955bf63d/0eecd/ups-nut-setup.jpg 622w","sizes":"(min-width: 622px) 622px, 100vw"},"sources":[{"srcSet":"/static/d99b0737a2868a414fc5fb40955bf63d/cd0b9/ups-nut-setup.webp 156w,\n/static/d99b0737a2868a414fc5fb40955bf63d/54d16/ups-nut-setup.webp 311w,\n/static/d99b0737a2868a414fc5fb40955bf63d/2de4c/ups-nut-setup.webp 622w","type":"image/webp","sizes":"(min-width: 622px) 622px, 100vw"}]},"width":622,"height":362}}},{"childImageSharp":{"gatsbyImageData":{"layout":"constrained","backgroundColor":"#f8f8f8","images":{"fallback":{"src":"/static/6465327efe88b69db64f7fbca75fe30c/37173/nut-server.jpg","srcSet":"/static/6465327efe88b69db64f7fbca75fe30c/c1779/nut-server.jpg 532w,\n/static/6465327efe88b69db64f7fbca75fe30c/de5cf/nut-server.jpg 1063w,\n/static/6465327efe88b69db64f7fbca75fe30c/37173/nut-server.jpg 2126w","sizes":"(min-width: 2126px) 2126px, 100vw"},"sources":[{"srcSet":"/static/6465327efe88b69db64f7fbca75fe30c/a21ec/nut-server.webp 532w,\n/static/6465327efe88b69db64f7fbca75fe30c/37a56/nut-server.webp 1063w,\n/static/6465327efe88b69db64f7fbca75fe30c/1cd95/nut-server.webp 2126w","type":"image/webp","sizes":"(min-width: 2126px) 2126px, 100vw"}]},"width":2126,"height":1200}}}]}}},"pageContext":{"id":"48be1a6d-528c-5521-a4f5-9dd42c5afa4f","slug":"22-01-nut-server/","__params":{"slug":"22-01-nut-server"}}},
    "staticQueryHashes": ["2744905544","3159585216"]}